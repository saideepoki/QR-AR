<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Image Animation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mind-ar/1.2.2/mindar-image.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mind-ar/1.2.2/mindar-image-three.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r132/three.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-family: Arial, sans-serif;
            font-size: 24px;
            z-index: 999;
        }
        
        #instructions {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            font-family: Arial, sans-serif;
        }
        
        #permission-button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 18px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #error {
            color: #ff4444;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="loading">
        Loading AR Experience...<br>
        <div id="error"></div>
        <button id="permission-button">Allow Camera Access</button>
    </div>
    
    <div id="instructions">
        Point your camera at the target image
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loadingScreen = document.getElementById('loading');
            const instructions = document.getElementById('instructions');
            const permissionButton = document.getElementById('permission-button');
            const errorDisplay = document.getElementById('error');
            
            // Initialize AR experience
            const startAR = async () => {
                try {
                    // First check camera permissions
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    // Stop the stream immediately - we just needed permission
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Initialize MindAR
                    const mindarThree = new window.MINDAR.IMAGE.MindARThree({
                        container: document.body,
                        imageTargetSrc: 'targets.mind',
                        uiScanning: true,
                        uiLoading: false
                    });
                    
                    const {renderer, scene, camera} = mindarThree;
                    
                    // Create a video plane to show animation
                    const video = document.createElement('video');
                    video.src = 'animation.mp4'; // Better to use mp4 than gif
                    video.loop = true;
                    video.muted = true;
                    video.playsInline = true;
                    
                    const videoTexture = new THREE.VideoTexture(video);
                    const videoGeometry = new THREE.PlaneGeometry(1, 1080/1920);
                    const videoMaterial = new THREE.MeshBasicMaterial({map: videoTexture});
                    const videoMesh = new THREE.Mesh(videoGeometry, videoMaterial);
                    
                    // Create anchor
                    const anchor = mindarThree.addAnchor(0);
                    anchor.group.add(videoMesh);
                    
                    // Play video once tracking starts
                    anchor.onTargetFound = () => {
                        video.play().catch(e => console.error("Video play failed:", e));
                        instructions.style.display = 'none';
                    };
                    
                    anchor.onTargetLost = () => {
                        video.pause();
                        instructions.style.display = 'block';
                    };
                    
                    // Start AR
                    await mindarThree.start();
                    loadingScreen.style.display = 'none';
                    
                    // Render loop
                    renderer.setAnimationLoop(() => {
                        renderer.render(scene, camera);
                    });
                } catch (err) {
                    console.error("AR initialization failed:", err);
                    errorDisplay.textContent = "Failed to access camera: " + err.message;
                    errorDisplay.style.display = 'block';
                    permissionButton.style.display = 'block';
                }
            };
            
            // Add click handler for permission button
            permissionButton.addEventListener('click', async () => {
                permissionButton.style.display = 'none';
                errorDisplay.style.display = 'none';
                await startAR();
            });
            
            // Try to start automatically
            startAR().catch(() => {
                // If auto-start fails, show the permission button
                permissionButton.style.display = 'block';
            });
        });
    </script>
</body>
</html>